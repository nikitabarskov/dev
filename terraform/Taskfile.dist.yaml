version: 3

vars:
  DOCKER_COMPOSE_RUN: "docker compose run --rm"
  BUILD_CACHE_ARGS: ""

tasks:
  build-devtools:
    desc: "Build devtools images: tfswitch and tflint"
    sources:
      - "Dockerfile"
      - "*_checksums.txt"
      - "Taskfile.dist.yaml"
    cmds:
      - "echo $BUILD_CACHE_ARGS"
      - "docker buildx build --target tfswitch {{ .BUILD_CACHE_ARGS }} ."
      - "docker buildx build --target tflint {{ .BUILD_CACHE_ARGS }} ."
  install:
    desc: Install terraform and init terraform workspace
    sources:
      - ".terraform.lock.hcl"
      - "backend.tf"
      - "versions.tf"
      - "Taskfile.dist.yaml"
    cmds:
      - "{{ .DOCKER_COMPOSE_RUN }} terraform bash -c 'tfswitch && terraform init {{ .TERRAFORM_INIT_ARGS }}'"
    generates:
      - ".terraform.lock.hcl"
      - ".terraform/*"
    deps:
      - task: build-devtools
  validate:
    desc: Run terraform validation
    sources:
      - "*.tf"
      - ".terraform.lock.hcl"
      - "docker-compose.yaml"
      - "Dockerfile"
      - "Taskfile.dist.yaml"
    cmds:
      - "{{ .DOCKER_COMPOSE_RUN }} terraform bash -c 'tfswitch && terraform fmt -check -diff -recursive .'"
      - "{{ .DOCKER_COMPOSE_RUN }} terraform bash -c 'tfswitch && terraform validate'"
      - "{{ .DOCKER_COMPOSE_RUN }} tflint ."
    deps:
      - task: install
  format-fix:
    desc: Fix formatting issues
    cmds:
      - "{{ .DOCKER_COMPOSE_RUN }} terraform bash -c 'tfswitch && terraform fmt -diff -recursive .'"
