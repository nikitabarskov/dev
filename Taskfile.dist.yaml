version: "3"

includes:
  terraform:
    taskfile: ./terraform
    dir: ./terraform

vars:
  DOCKER_COMPOSE_RUN: docker compose run --rm

tasks:
  build-security-devtools:
    desc: "Build security devtools images: syft, grype and trivy"
    sources:
      - "Dockerfile"
      - "docker-lock.json"
      - "Taskfile.dist.yaml"
    cmds:
      - "docker buildx build --target syft --tag ocreg.invalid/syft:latest {{ .BUILD_CACHE_ARGS }} ."
      - "docker buildx build --target grype --tag ocreg.invalid/syft:latest {{ .BUILD_CACHE_ARGS }} ."
      - "docker buildx build --target trivy --tag ocreg.invalid/trivy:latest {{ .BUILD_CACHE_ARGS }} ."

  validate-security:
    desc: Validate security issues with trivy inside the repository
    cmds:
      - "{{ .DOCKER_COMPOSE_RUN }} syft dir:."
      - "{{ .DOCKER_COMPOSE_RUN }} grype sbom:dependencies.syft.json || true"
      - "{{ .DOCKER_COMPOSE_RUN }} trivy filesystem --security-checks=vuln,config,secret --format=sarif --no-progress --output=misconfiguration-and-vulnerabilities.trivy.sarif . || true"
    deps:
      - task: build-security-devtools

  build-docker-lock-devtools:
    desc: "Build docker-lock devtools image"
    sources:
      - "Dockerfile"
      - "docker-lock.json"
      - "Taskfile.dist.yaml"
    cmds:
      - "docker buildx build --target docker-lock --tag ocreg.invalid/docker-lock:latest {{ .BUILD_CACHE_ARGS }} ."

  validate-images-digests:
    desc: Validate images digests with docker-lock inside the repository
    cmds:
      - "{{ .DOCKER_COMPOSE_RUN }} docker-lock lock verify"
    deps:
      - task: build-docker-lock-devtools

  lock-images-digests:
    desc: Lock and rewrite images digests inside the repository
    sources:
      - "*/**/*Dockerfile"
      - "*/**/*docker-compose.yaml"
    cmds:
      - "{{ .DOCKER_COMPOSE_RUN }} docker-lock lock generate"
      - "{{ .DOCKER_COMPOSE_RUN }} docker-lock lock rewrite"
    generates:
      - "docker-lock.json"
    deps:
      - task: build-docker-lock-devtools

  build-node-devtools:
    desc: "Build node devtools image"
    sources:
      - "Dockerfile"
      - "docker-lock.json"
      - "Taskfile.dist.yaml"
    cmds:
      - "docker buildx build --target node --tag ocreg.invalid/node:latest {{ .BUILD_CACHE_ARGS }} ."

  install-prettier:
    desc: Install prettier
    sources:
      - "package.json"
      - "yarn.lock"
      - "Dockerfile"
      - "prettierrc.json"
    cmds:
      - "{{ .DOCKER_COMPOSE_RUN }} node yarn install --frozen-lockfile --verbose"
    generates:
      - "node_modules"
    deps:
      - task: build-node-devtools

  format-fix:
    desc: Fix formatting issues with prettier for the whole repo
    cmds:
      - "{{ .DOCKER_COMPOSE_RUN }} node yarn prettier --write --loglevel debug ."
    deps:
      - task: install-prettier

  format-check:
    desc: Check formatting issues with prettier for the whole repo
    cmds:
      - "{{ .DOCKER_COMPOSE_RUN }} node yarn prettier --check --loglevel debug ."
    deps:
      - task: install-prettier
